apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: observability
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: true
        jsonData:
          timeInterval: "15s"
      - name: Loki
        type: loki
        access: proxy
        url: http://loki:3100
        editable: true
        jsonData:
          maxLines: 1000
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-config
  namespace: observability
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-app
  namespace: observability
data:
  app-dashboard.json: |
    {
      "dashboard": {
        "title": "Application Metrics",
        "tags": ["application"],
        "timezone": "browser",
        "panels": [
          {
            "title": "Request Rate",
            "targets": [
              {
                "expr": "sum(rate(http_requests_total[5m])) by (endpoint)"
              }
            ],
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "title": "Error Rate",
            "targets": [
              {
                "expr": "sum(rate(http_requests_total{status=~\"5..\"}[5m])) by (endpoint)"
              }
            ],
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "title": "Request Duration (95th percentile)",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, endpoint))"
              }
            ],
            "type": "graph",
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8}
          }
        ],
        "schemaVersion": 16,
        "version": 0
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-kubernetes
  namespace: observability
data:
  kubernetes-dashboard.json: |
    {
      "dashboard": {
        "title": "Kubernetes Cluster Metrics",
        "tags": ["kubernetes"],
        "timezone": "browser",
        "panels": [
          {
            "title": "CPU Usage by Pod",
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total{pod!=\"\"}[5m])) by (pod, namespace)"
              }
            ],
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "title": "Memory Usage by Pod",
            "targets": [
              {
                "expr": "sum(container_memory_usage_bytes{pod!=\"\"}) by (pod, namespace)"
              }
            ],
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "title": "Pod Restarts",
            "targets": [
              {
                "expr": "sum(kube_pod_container_status_restarts_total) by (pod, namespace)"
              }
            ],
            "type": "graph",
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8}
          }
        ],
        "schemaVersion": 16,
        "version": 0
      }
    }
